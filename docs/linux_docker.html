<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title></title>
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" type="text/css" href="assets/prism.css" media="all">
<link rel="stylesheet" type="text/css" href="assets/index.css" media="all">
<script src="assets/prism.js"></script>
<script src="assets/index.js"></script>
</head>
<body>

<div class="container">
<a href="index.html">INDEX</a> | <a href="https://github.com/mamemomonga/snippets">GitHub</a><hr>
<h1 id="docker">Docker</h1>
<h2 id="-ubuntu-16-04-3-lts-">セットアップ (Ubuntu 16.04.3 LTS)</h2>
<ul>
<li>OverlayFS2 を使用する</li>
<li>dockerデータを別ディスクに設定する</li>
</ul>
<h3 id="docker-">Dockerのインストールとセットアップ</h3>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{"wrap":"sudo bash -eu"}'>wget https://get.docker.com -O - | sh
systemctl stop docker

CONFIGURATION_FILE=$(systemctl show --property=FragmentPath docker | cut -f2 -d=)
echo "[CONFIGURATION_FILE] $CONFIGURATION_FILE"
cp $CONFIGURATION_FILE /etc/systemd/system/docker.service

perl -pi -e 's/^(ExecStart=.+)$/$1 -s overlay2/' /etc/systemd/system/docker.service
systemctl daemon-reload
systemctl start docker
docker info 2>&1 | grep 'Storage Driver'</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー (sudo bash -eu)"><br>
</div><p>現在のユーザをdockerコマンドを実行できるようにする</p>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{"wrap":"sudo bash -xeu"}'>usermod -a -G docker $USER</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー (sudo bash -xeu)"><br>
</div><p>いったんログアウトする</p>
<h3 id="docker-compose-">Docker Composeのインストール</h3>
<p><a href="https://docs.docker.com/compose/install/#install-compose">こちらで</a> 最新版を確認する</p>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{"wrap":"sudo bash -xeu"}'>curl -L https://github.com/docker/compose/releases/download/1.17.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod 755 /usr/local/bin/docker-compose</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー (sudo bash -xeu)"><br>
</div><p>実行の確認</p>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{}'>docker-compose --version</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー"><br>
</div><h3 id="-">データを別ボリュームに置く</h3>
<p>新しいディスクを追加する。/dev/xvdf(/dev/sdf)に割り当てるものとする</p>
<p><strong>割り当てドライブを十分に確認すること</strong></p>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{"wrap":"sudo bash -xeu"}'>fdisk /dev/xvdf << 'EOS'
n
p
1


w
q
EOS</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー (sudo bash -xeu)"><br>
</div><p>コピペする場合は先頭の $ は除去して一行づつ確認しながら実行</p>
<div class="code"><pre class="line-numbers">
<code class="language-bash" data-config='{}'>$ sudo mkfs.ext4 /dev/xvdf1
$ sudo mount /dev/xvdf1 /mnt
$ sudo e2label /dev/xvdf1 docker
$ sudo service docker stop
$ sudo sh -c 'cp -a /var/lib/docker/* /mnt'
$ sudo rm -rf /var/lib/docker
$ sudo mkdir /var/lib/docker
$ sudo sh -c 'echo "LABEL=docker /var/lib/docker ext4 defaults,discard 0 0" >> /etc/fstab'
$ sudo mount -a

$ ls /var/lib/docker
$ sudo service docker start
$ docker info</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー"><br>
</div>
<hr><a href="index.html">INDEX</a> | <a href="https://github.com/mamemomonga/snippets">GitHub</a>
</div>

</body>
</html>
