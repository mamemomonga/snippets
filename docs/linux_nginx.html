<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title></title>
<meta name="viewport" content="width=1000px">
<link rel="stylesheet" type="text/css" href="assets/prism.css" media="all">
<link rel="stylesheet" type="text/css" href="assets/index.css" media="all">
<script src="assets/prism.js"></script>
<script src="assets/index.js"></script>
</head>
<body>

<div class="container">
<a href="index.html">INDEX</a> | <a href="https://github.com/mamemomonga/snippets">GitHub</a><hr>
<h1 id="nginx">nginx</h1>
<p><a href="https://nginx.org/en/">https://nginx.org/en/</a></p>
<h1 id="ubuntu-">Ubuntuへのインストール</h1>
<div class="code"><pre class="">
<code class="language-bash" data-config='{"wrap":"sudo bash -eux"}'>. /etc/lsb-release
cat &gt;&gt; /etc/apt/sources.list &lt;&lt; EOS
# nginx
deb http://nginx.org/packages/ubuntu/ $DISTRIB_CODENAME nginx
deb-src http://nginx.org/packages/ubuntu/ $DISTRIB_CODENAME nginx
EOS

curl -o /tmp/nginx_signing.key https://nginx.org/keys/nginx_signing.key
apt-key add /tmp/nginx_signing.key
apt-get -y update
apt-get -y install nginx</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー (sudo bash -eux)"><br>
</div><h1 id="nginx-conf">nginx.conf</h1>
<h2 id="nginx-ip-basic-">nginxでIP制限とBasic認証を併用する</h2>
<p>IP制限のルールにマッチしない場合はBASIC認証を行う</p>
<div class="code"><pre class="">
<code class="language-nginx" data-config='{"language":"nginx"}'>http {
    get $access_allowed {
        default disable;
        127.0.0.1 allow;
        192.168.0.0/24 allow;    
    }

    # IP制限のみ
    server {
        listen       80;
        server_name  _;

        if ($access_allowed = &quot;disable&quot;) { return 403; }

        location / {
            proxy_set_header Host            $http_host;
            proxy_set_header X-Real-IP       $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header X-Forwarded-Proto &#39;https&#39;;
            proxy_pass http://127.0.0.1:8001;
        }
    }

    # IP制限とBASIC認証
    server {
        listen       80;
        server_name  _;

        set $realm off;
        if ( $access_allowed = &quot;disable&quot; ) {
            set $realm &quot;Restricted&quot;;
        }
        auth_basic $realm;
        auth_basic_user_file /etc/nginx/htpasswd;

        location / {
            proxy_set_header Host            $http_host;
            proxy_set_header X-Real-IP       $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header X-Forwarded-Proto &#39;https&#39;;
            proxy_pass http://127.0.0.1:8001;
        }
    }
}</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー"><br>
</div><p>htpasswdは debian系ならば apache2-utils にある</p>
<div class="code"><pre class="">
<code class="language-bash" data-config='{}'>htpasswd -c /etc/nginx/htpasswd [USERNAME]</code></pre>
<pre><code class="copyarea"></code></pre>
<input type="button" onclick="bt_copy_range(this)" value="コピー"><br>
</div>
<hr><a href="index.html">INDEX</a> | <a href="https://github.com/mamemomonga/snippets">GitHub</a>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109885867-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109885867-2');
</script>

</body>
</html>
